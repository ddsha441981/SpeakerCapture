name: Build and Release SpeakerCapture

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install PulseAudio dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libpulse-dev \
          libpulse0 \
          pulseaudio-utils \
          pkg-config
    
    - name: Create build directory
      run: mkdir build
    
    - name: Configure CMake
      run: |
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local
    
    - name: Build project
      run: |
        cd build
        make -j$(nproc)
    
    - name: Test build (basic verification)
      run: |
        cd build
        ./SpeakerCapture --help || echo "Binary created successfully"
        ldd ./SpeakerCapture
    
    - name: Package for Linux
      run: |
        cd build
        strip SpeakerCapture
        tar czf ../speakercapture-${{ github.ref_name }}-linux-x86_64.tar.gz SpeakerCapture
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          speakercapture-${{ github.ref_name }}-linux-x86_64.tar.gz
        body: |
          # SpeakerCapture ${{ github.ref_name }}
          
          **Linux PulseAudio Speaker Output Recorder**
          
          ## 🎵 Features
          - **Real-time Audio Capture**: Records speaker output directly from PulseAudio
          - **WAV Format Output**: High-quality uncompressed audio recording
          - **Configurable Parameters**: Adjustable sample rate, channels, and buffer size
          - **Low Latency**: Optimized for real-time audio processing
          - **Optional Playback**: Monitor audio while recording
          
          ## 📋 Requirements
          - Linux with PulseAudio
          - PulseAudio runtime libraries
          
          ## 📥 Installation
          ```
          tar -xzf speakercapture-${{ github.ref_name }}-linux-x86_64.tar.gz
          chmod +x SpeakerCapture
          ```
          
          ## 🚀 Usage
          ```
          # Basic usage (default settings)
          ./SpeakerCapture
          
          # Custom device and settings
          ./SpeakerCapture [device] [sample_rate] [channels] [buffer_ms] [playback_enabled]
          
          # Example with custom settings
          ./SpeakerCapture alsa_output.pci-0000_00_1f.3.analog-stereo.monitor 44100 2 50 0
          ```
          
          ## 🎛️ Parameters
          - **device**: PulseAudio device name (default: alsa_output.pci-0000_00_1f.3.analog-stereo.monitor)
          - **sample_rate**: Audio sample rate in Hz (default: 16000)
          - **channels**: Number of audio channels 1-8 (default: 1)  
          - **buffer_ms**: Buffer size in milliseconds (default: 100)
          - **playback_enabled**: Enable audio playback 0/1 (default: 0)
          
          ## 🔧 Audio Device Discovery
          ```
          # List available PulseAudio sources
          pactl list short sources
          
          # List available monitors (for speaker capture)
          pactl list short sources | grep monitor
          ```
          
          ## 📁 Output
          - Creates `speaker_output.wav` in the current directory
          - Press Ctrl+C to stop recording and save the file
          - Real-time latency reporting during recording
          
          ## 🖥️ Supported Systems
          - Ubuntu 18.04+
          - Debian 9+
          - Fedora 30+
          - Arch Linux
          - Other Linux distributions with PulseAudio
          
          ## 🏗️ Build Information
          - **Built with**: CMake + GCC
          - **C++ Standard**: C++17
          - **Dependencies**: PulseAudio, pthread
          - **Architecture**: x86_64
          
          **Note**: This tool captures system audio output and requires PulseAudio to be running.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-documentation:
    runs-on: ubuntu-latest
    needs: build-linux
    steps:
    - uses: actions/checkout@v4
    
    - name: Create README for release
      run: |
        cat > RELEASE_README.md << 'EOF'
        # SpeakerCapture - Audio Output Recorder
        
        A lightweight C++ application for capturing speaker output on Linux systems using PulseAudio.
        
        ## Quick Start
        1. Extract the binary: `tar -xzf speakercapture-*.tar.gz`
        2. Run with default settings: `./SpeakerCapture`
        3. Stop recording with Ctrl+C
        4. Find your recording in `speaker_output.wav`
        
        ## Advanced Usage
        ```
        # Record in stereo at 44.1kHz
        ./SpeakerCapture alsa_output.pci-0000_00_1f.3.analog-stereo.monitor 44100 2
        
        # Record with playback monitoring enabled
        ./SpeakerCapture default 16000 1 100 1
        ```
        
        ## Troubleshooting
        - **Permission denied**: Make sure binary is executable (`chmod +x SpeakerCapture`)
        - **PulseAudio not found**: Install with `sudo apt install pulseaudio-utils libpulse0`
        - **No audio devices**: Check `pactl list short sources` for available devices
        - **High latency**: Reduce buffer size parameter (3rd argument)
        
        For more information, visit: https://github.com/${{ github.repository }}
        EOF
    
    - name: Upload README
      uses: softprops/action-gh-release@v1
      with:
        files: RELEASE_README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

